var RESULT={HIT:0,MISS:1,DODGE:2,CRIT:3,GLANCE:4},step=0,log=!1,version=2;class Simulation{constructor(e,s,t){this.player=e,this.timesecsmin=parseInt($('input[name="timesecsmin"]').val()),this.timesecsmax=parseInt($('input[name="timesecsmax"]').val()),this.startrage=parseInt($('input[name="startrage"]').val()),this.iterations=parseInt($('input[name="simulations"]').val()),this.idmg=0,this.totaldmg=0,this.totalduration=0,this.mindps=99999,this.maxdps=0,this.maxcallstack=Math.min(Math.floor(this.iterations/10),1e3),this.starttime=0,this.endtime=0,this.cb_update=t,this.cb_finished=s,this.player.simulation=this,this.spread=[],this.bloodfurystep=1e3*parseInt(spells[11].time),this.berserkingstep=1e3*parseInt(spells[10].time),this.reckstep=1e3*parseInt(spells[7].time),this.priorityap=parseInt(spells[4].priorityap),log=1==this.iterations}start(){this.run(1),this.starttime=(new Date).getTime()}run(e){step=0,this.idmg=0;let s,t,l=this.player;l.reset(this.startrage),this.maxsteps=rng(1e3*this.timesecsmin,1e3*this.timesecsmax),this.duration=this.maxsteps/1e3,this.executestep=Math.max(this.maxsteps-1e3*parseInt(spells[4].lasttime),0),this.fifteenstep=Math.max(this.maxsteps-16e3,0),this.twentystep=Math.max(this.maxsteps-21e3,0),this.thirtystep=Math.max(this.maxsteps-31e3,0),this.sixtystep=Math.max(this.maxsteps-61e3,0);let a=!1,r=0;for(;step<this.maxsteps;)if(0!=r&&step%3e3==0&&l.talents.angermanagement&&(l.rage=l.rage>=99?100:l.rage+1,a=!0),l.vaelbuff&&0!=r&&step%1e3==0&&(l.rage=l.rage>=80?100:l.rage+20,a=!0),l.mh.timer<=0&&(this.idmg+=l.attackmh(l.mh),a=!0),l.oh&&l.oh.timer<=0&&(this.idmg+=l.attackoh(l.oh),a=!0),a&&!l.spelldelay&&(l.spells.bloodrage&&l.spells.bloodrage.canUse()?(l.spelldelay=1,s=l.spells.bloodrage):l.auras.mightyragepotion&&l.auras.mightyragepotion.canUse()?(l.spelldelay=1,s=l.auras.mightyragepotion):l.timer||(l.auras.flask&&l.auras.flask.canUse()?(l.spelldelay=1,s=l.auras.flask):l.auras.cloudkeeper&&l.auras.cloudkeeper.canUse()&&step>this.thirtystep?(l.spelldelay=1,s=l.auras.cloudkeeper):l.auras.recklessness&&l.auras.recklessness.canUse()&&step>this.reckstep?(l.spelldelay=1,s=l.auras.recklessness):l.auras.deathwish&&l.auras.deathwish.canUse()?(l.spelldelay=1,s=l.auras.deathwish):l.auras.bloodfury&&l.auras.bloodfury.canUse()&&step>this.bloodfurystep?(l.spelldelay=1,s=l.auras.bloodfury):l.auras.berserking&&l.auras.berserking.canUse()&&step>this.berserkingstep?(l.spelldelay=1,s=l.auras.berserking):l.auras.slayer&&l.auras.slayer.canUse()&&step>this.twentystep?(l.spelldelay=1,s=l.auras.slayer):l.auras.spider&&l.auras.spider.canUse()&&step>this.fifteenstep?(l.spelldelay=1,s=l.auras.spider):l.auras.gabbar&&l.auras.gabbar.canUse()&&step>this.twentystep?(l.spelldelay=1,s=l.auras.gabbar):l.auras.earthstrike&&l.auras.earthstrike.canUse()&&step>this.twentystep?(l.spelldelay=1,s=l.auras.earthstrike):l.auras.pummeler&&l.auras.pummeler.canUse()&&step>this.thirtystep?(l.spelldelay=1,s=l.auras.pummeler):l.spells.execute&&step>=this.executestep?l.spells.bloodthirst&&l.stats.ap>=this.priorityap&&l.spells.bloodthirst.canUse()?(l.spelldelay=1,s=l.spells.bloodthirst):l.spells.mortalstrike&&l.stats.ap>=this.priorityap&&l.spells.mortalstrike.canUse()?(l.spelldelay=1,s=l.spells.mortalstrike):l.spells.execute.canUse()&&(l.spelldelay=1,s=l.spells.execute):l.spells.sunderarmor&&l.spells.sunderarmor.canUse()?(l.spelldelay=1,s=l.spells.sunderarmor):l.spells.bloodthirst&&l.spells.bloodthirst.canUse()?(l.spelldelay=1,s=l.spells.bloodthirst):l.spells.mortalstrike&&l.spells.mortalstrike.canUse()?(l.spelldelay=1,s=l.spells.mortalstrike):l.spells.whirlwind&&l.spells.whirlwind.canUse()?(l.spelldelay=1,s=l.spells.whirlwind):l.spells.overpower&&l.spells.overpower.canUse()?(l.spelldelay=1,s=l.spells.overpower):l.spells.hamstring&&l.spells.hamstring.canUse()&&(l.spelldelay=1,s=l.spells.hamstring)),l.heroicdelay&&(a=!1)),a&&!l.heroicdelay&&(!l.spells.execute||step<this.executestep?l.spells.heroicstrike&&l.spells.heroicstrike.canUse()&&(l.heroicdelay=1,t=l.spells.heroicstrike):l.spells.heroicstrikeexecute&&l.spells.heroicstrikeexecute.canUse()&&(l.heroicdelay=1,t=l.spells.heroicstrikeexecute),a=!1),l.spelldelay&&s&&l.spelldelay>s.maxdelay&&(l.heroicdelay&&t&&l.heroicdelay>t.maxdelay&&(l.heroicdelay=t.maxdelay-49),s.canUse()?(this.idmg+=l.cast(s),l.spelldelay=0,a=!0):l.spelldelay=0),l.heroicdelay&&t&&l.heroicdelay>t.maxdelay&&(t.canUse()?(l.cast(t),l.heroicdelay=0,a=!0):l.heroicdelay=0),l.spells.heroicstrike&&l.spells.heroicstrike.unqueue&&l.nextswinghs&&l.rage<l.spells.heroicstrike.unqueue&&l.mh.timer<=l.spells.heroicstrike.unqueuetimer&&(this.player.nextswinghs=!1),l.extraattacks>0&&(l.mh.timer=0,l.extraattacks--),l.batchedextras>0&&(l.mh.timer=400-step%400,l.batchedextras--),!l.mh.timer||!l.spelldelay&&a||!l.heroicdelay&&a)r=0;else{if(r=Math.min(l.mh.timer,l.oh?l.oh.timer:9999),l.spelldelay&&s.maxdelay-l.spelldelay<r&&(r=s.maxdelay-l.spelldelay+1),l.heroicdelay&&t.maxdelay-l.heroicdelay<r&&(r=t.maxdelay-l.heroicdelay+1),l.timer&&l.timer<r&&(r=l.timer),l.itemtimer&&l.itemtimer<r&&(r=l.itemtimer),l.talents.angermanagement&&3e3-step%3e3<r&&(r=3e3-step%3e3),l.vaelbuff&&1e3-step%1e3<r&&(r=1e3-step%1e3),l.auras.bloodrage&&l.auras.bloodrage.timer&&1e3-(step-l.auras.bloodrage.starttimer)%1e3<r&&(r=1e3-(step-l.auras.bloodrage.starttimer)%1e3),l.spells.bloodthirst&&l.spells.bloodthirst.timer&&l.spells.bloodthirst.timer<r&&(r=l.spells.bloodthirst.timer),l.spells.mortalstrike&&l.spells.mortalstrike.timer&&l.spells.mortalstrike.timer<r&&(r=l.spells.mortalstrike.timer),l.spells.whirlwind&&l.spells.whirlwind.timer&&l.spells.whirlwind.timer<r&&(r=l.spells.whirlwind.timer),l.spells.bloodrage&&l.spells.bloodrage.timer&&l.spells.bloodrage.timer<r&&(r=l.spells.bloodrage.timer),l.spells.overpower&&l.spells.overpower.timer&&l.spells.overpower.timer<r&&(r=l.spells.overpower.timer),l.spells.execute&&l.spells.execute.timer&&l.spells.execute.timer<r&&(r=l.spells.execute.timer),l.spells.heroicstrike&&l.spells.heroicstrike.unqueue){let e=Math.max(l.mh.timer-l.spells.heroicstrike.unqueuetimer);e>0&&e<r&&(r=e)}step+=r,l.mh.step(r),l.oh&&l.oh.step(r),l.timer&&l.steptimer(r)&&!l.spelldelay&&(a=!0),l.itemtimer&&l.stepitemtimer(r)&&!l.spelldelay&&(a=!0),l.dodgetimer&&l.stepdodgetimer(r),l.spelldelay&&(l.spelldelay+=r),l.heroicdelay&&(l.heroicdelay+=r),l.spells.bloodthirst&&l.spells.bloodthirst.timer&&!l.spells.bloodthirst.step(r)&&!l.spelldelay&&(a=!0),l.spells.mortalstrike&&l.spells.mortalstrike.timer&&!l.spells.mortalstrike.step(r)&&!l.spelldelay&&(a=!0),l.spells.whirlwind&&l.spells.whirlwind.timer&&!l.spells.whirlwind.step(r)&&!l.spelldelay&&(a=!0),l.spells.bloodrage&&l.spells.bloodrage.timer&&!l.spells.bloodrage.step(r)&&!l.spelldelay&&(a=!0),l.spells.overpower&&l.spells.overpower.timer&&!l.spells.overpower.step(r)&&!l.spelldelay&&(a=!0),l.spells.execute&&l.spells.execute.timer&&!l.spells.execute.step(r)&&!l.spelldelay&&(a=!0),l.auras.bloodrage&&l.auras.bloodrage.timer&&!l.auras.bloodrage.step(r)&&!l.spelldelay&&(a=!0)}l.endauras(),this.totaldmg+=this.idmg,this.totalduration+=this.duration;let i=this.idmg/this.duration;if(i<this.mindps&&(this.mindps=i),i>this.maxdps&&(this.maxdps=i),i=Math.round(i),this.spread[i]?this.spread[i]++:this.spread[i]=1,e==this.iterations)this.endtime=(new Date).getTime(),this.cb_finished&&this.cb_finished();else if(e%this.maxcallstack==0){let s=this;this.cb_update&&this.cb_update(e),setTimeout(function(){s.run(e+1)},0)}else this.run(e+1)}}function rng(e,s){return~~(Math.random()*(s-e+1)+e)}function rng10k(){return~~(1e4*Math.random())}function avg(e,s){return(e+s)/2}