var RESULT={HIT:0,MISS:1,DODGE:2,CRIT:3,GLANCE:4};class Simulation{constructor(s,t,e){this.player=s,this.timesecsmin=parseInt($('input[name="timesecsmin"]').val()),this.timesecsmax=parseInt($('input[name="timesecsmax"]').val()),this.startrage=parseInt($('input[name="startrage"]').val()),this.iterations=parseInt($('input[name="simulations"]').val()),this.idmg=0,this.totaldmg=0,this.totalduration=0,this.mindps=99999,this.maxdps=0,this.maxcallstack=Math.min(Math.floor(this.iterations/10),1e3),this.starttime=0,this.endtime=0,this.cb_update=e,this.cb_finished=t,this.player.simulation=this,this.spread=[],this.bloodfurystep=1e3*parseInt(spells[11].time),this.berserkingstep=1e3*parseInt(spells[10].time),this.reckstep=1e3*parseInt(spells[7].time),this.priorityap=parseInt(spells[4].priorityap)}start(){this.run(1),this.starttime=(new Date).getTime()}run(s){this.step=1,this.idmg=0;let t=this.player;for(t.reset(this.startrage),this.maxsteps=rng(1e3*this.timesecsmin,1e3*this.timesecsmax),this.duration=this.maxsteps/1e3,this.executestep=Math.max(this.maxsteps-1e3*parseInt(spells[4].lasttime),0),this.fifteenstep=Math.max(this.maxsteps-16e3,0),this.twentystep=Math.max(this.maxsteps-21e3,0),this.thirtystep=Math.max(this.maxsteps-31e3,0),this.sixtystep=Math.max(this.maxsteps-61e3,0);this.step<this.maxsteps;){let s,e=400-this.step%400;s=t.mh.timer>=e&&(!t.oh||t.oh.timer>=e)?e:Math.min(t.mh.timer,t.oh?t.oh.timer:9999),this.step+=s;let a=this.step%400==0;a&&this.step%3e3<=200&&t.talents.angermanagement&&(t.rage=t.rage>=99?100:t.rage+1),a&&t.vaelbuff&&this.step%1e3<=200&&(t.rage=t.rage>=80?100:t.rage+20),t.mh.step(s),t.oh&&t.oh.step(s),a&&t.step(this),0==t.mh.timer&&(this.idmg+=t.attackmh(t.mh,t.nextswingwf)),t.oh&&0==t.oh.timer&&(this.idmg+=t.attackoh(t.oh)),a&&0==t.timer&&(t.spells.bloodrage&&t.spells.bloodrage.canUse()?t.spells.bloodrage.use():t.auras.mightyragepotion&&t.auras.mightyragepotion.canUse(this.step)?t.auras.mightyragepotion.use():t.auras.cloudkeeper&&t.auras.cloudkeeper.canUse()&&this.step>this.thirtystep?t.auras.cloudkeeper.use():t.auras.flask&&t.auras.flask.canUse()&&this.step>this.sixtystep?t.auras.flask.use():t.auras.slayer&&t.auras.slayer.canUse()&&this.step>this.twentystep?t.auras.slayer.use():t.auras.spider&&t.auras.spider.canUse()&&this.step>this.fifteenstep?t.auras.spider.use():t.auras.gabbar&&t.auras.gabbar.canUse()&&this.step>this.twentystep?t.auras.gabbar.use():t.auras.earthstrike&&t.auras.earthstrike.canUse()&&this.step>this.twentystep?t.auras.earthstrike.use():t.auras.pummeler&&t.auras.pummeler.canUse()&&this.step>this.thirtystep?t.auras.pummeler.use():t.spells.sunderarmor&&t.spells.sunderarmor.canUse()?this.idmg+=t.cast(t.spells.sunderarmor):t.auras.deathwish&&t.auras.deathwish.canUse(this.step)?t.auras.deathwish.use():t.auras.bloodfury&&t.auras.bloodfury.canUse()&&this.step>this.bloodfurystep?t.auras.bloodfury.use():t.auras.berserking&&t.auras.berserking.canUse()&&this.step>this.berserkingstep?t.auras.berserking.use():t.auras.recklessness&&t.auras.recklessness.canUse()&&this.step>this.reckstep?t.auras.recklessness.use():t.spells.execute&&this.step>this.executestep?t.spells.bloodthirst&&t.stats.ap>=this.priorityap&&t.spells.bloodthirst.canUse()?this.idmg+=t.cast(t.spells.bloodthirst):t.spells.mortalstrike&&t.stats.ap>=this.priorityap&&t.spells.mortalstrike.canUse()?this.idmg+=t.cast(t.spells.mortalstrike):t.spells.execute.canUse()&&(this.idmg+=t.cast(t.spells.execute)):t.spells.overpower&&t.spells.overpower.canUse()?this.idmg+=t.cast(t.spells.overpower):t.spells.bloodthirst&&t.spells.bloodthirst.canUse()?this.idmg+=t.cast(t.spells.bloodthirst):t.spells.mortalstrike&&t.spells.mortalstrike.canUse()?this.idmg+=t.cast(t.spells.mortalstrike):t.spells.heroicstrike&&t.spells.heroicstrike.canUse()?t.spells.heroicstrike.use():t.spells.whirlwind&&t.spells.whirlwind.canUse()?this.idmg+=t.cast(t.spells.whirlwind):t.spells.hamstring&&t.spells.hamstring.canUse()&&(this.idmg+=t.cast(t.spells.hamstring))),a&&t.spells.heroicstrike&&t.mh.timer<=400&&t.rage<t.spells.heroicstrike.unqueue&&(this.player.nextswinghs=!1),t.extraattacks>0&&(t.mh.timer=0,t.extraattacks--),t.batchedextras>0&&(t.mh.timer=400-this.step%400,t.batchedextras--)}this.totaldmg+=this.idmg,this.totalduration+=this.duration;let e=this.idmg/this.duration;if(e<this.mindps&&(this.mindps=e),e>this.maxdps&&(this.maxdps=e),e=Math.round(e),this.spread[e]?this.spread[e]++:this.spread[e]=1,s==this.iterations)this.endtime=(new Date).getTime(),this.cb_finished&&this.cb_finished();else if(s%this.maxcallstack==0){let t=this;this.cb_update&&this.cb_update(s),setTimeout(function(){t.run(s+1)},0)}else this.run(s+1)}}function rng(s,t){return~~(Math.random()*(t-s+1)+s)}function rng10k(){return~~(1e4*Math.random())}function avg(s,t){return(s+t)/2}